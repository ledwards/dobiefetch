<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dobiefetch API Documentation</title>
  <style>
    body { font-family: Georgia, serif; margin: 2rem; line-height: 1.5; color: #1e1e1e; }
    h1, h2, h3 { font-family: "Trebuchet MS", sans-serif; }
    code, pre { background: #f5f5f5; padding: 0.2rem 0.4rem; border-radius: 4px; }
    pre { padding: 1rem; overflow-x: auto; }
    section { margin-bottom: 2rem; }
  </style>
</head>
<body>
  <h1>Dobiefetch API Documentation</h1>

  <section>
    <h2>Overview</h2>
    <p>This API provides read-only access to dog adoption listings scraped from PetPlace.</p>
    <ul>
      <li>Base URL: <code>https://dobiefetch.vercel.app</code> (local: <code>http://localhost:3000</code>)</li>
      <li>Auth: Shared secret via <code>X-API-Key</code> header or <code>Authorization: Bearer &lt;API_KEY&gt;</code></li>
      <li>Content type: JSON</li>
    </ul>
  </section>

  <section>
    <h2>Authentication</h2>
    <p>All endpoints except <code>/health</code> require authentication.</p>
    <pre>GET /dogs
X-API-Key: your-secret</pre>
  </section>

  <section>
    <h2>Dog Schema (full)</h2>
    <pre>{
  "id": "string",
  "source": "string",
  "source_animal_id": "string",
  "client_id": "string",
  "name": "string",
  "full_name": "string|null",
  "animal_type": "string",
  "primary_breed": "string|null",
  "secondary_breed": "string|null",
  "breed1": "string|null",
  "breed2": "string|null",
  "breed_display": "string|null",
  "age": "string|null",
  "age_display": "string|null",
  "gender": "string|null",
  "size_category": "string|null",
  "description_html": "string|null",
  "bio_html": "string|null",
  "more_info_html": "string|null",
  "placement_info": "string|null",
  "weight_lbs": "number|null",
  "status": "string|null",
  "cover_image_url": "string|null",
  "located_at": "string|null",
  "brought_to_shelter": "string|null",
  "city": "string|null",
  "state": "string|null",
  "lat": "number|null",
  "lon": "number|null",
  "filter_breed_group": "string|null",
  "client_sort": "number|null",
  "listing_url": "string",
  "source_api_url": "string",
  "data_updated_note": "string|null",
  "filters": {
    "filter_age": "string|null",
    "filter_gender": "string|null",
    "filter_size": "string|null",
    "filter_dob": "string|null",
    "filter_days_out": "number|null",
    "filter_primary_breed": "string|null"
  },
  "shelter": {
    "name": "string",
    "address_line1": "string|null",
    "city": "string|null",
    "state": "string|null",
    "zip": "string|null",
    "phone": "string|null",
    "email": "string|null",
    "website_url": "string|null",
    "location_label": "string|null",
    "location_address_html": "string|null"
  },
  "photos": [
    { "url": "string", "is_primary": "boolean", "position": "number" }
  ],
  "raw_payload": "object",
  "ingested_at": "string",
  "source_updated_at": "string|null"
}</pre>
  </section>

  <section>
    <h2>Endpoints</h2>

    <h3>GET /health</h3>
    <p>No auth required. Returns <code>200 OK</code> with body <code>OK</code>.</p>

    <h3>GET /dogs</h3>
    <p>List dogs with optional filters and search. Returns full dog records (including photos and raw payload).</p>
    <ul>
      <li><code>q</code>: substring search across name, breeds, description, shelter name</li>
      <li><code>breed</code>: substring match against primary breed</li>
      <li><code>age</code>: exact match</li>
      <li><code>gender</code>: exact match</li>
      <li><code>size</code>: exact match</li>
      <li><code>status</code>: exact match</li>
      <li><code>client_id</code>: exact match</li>
      <li><code>source_animal_id</code>: exact match</li>
      <li><code>limit</code>: number of dogs (default 50, max 200)</li>
      <li><code>offset</code>: offset for pagination</li>
    </ul>
    <pre>GET /dogs?breed=Doberman&amp;limit=10
X-API-Key: your-secret</pre>

    <h3>GET /dogs/:id</h3>
    <p>Fetch a single dog by internal id. Returns the same full schema as <code>/dogs</code>.</p>
    <pre>GET /dogs/abc123
X-API-Key: your-secret</pre>
  </section>

  <section>
    <h2>Error Responses</h2>
    <ul>
      <li><code>401 Unauthorized</code>: missing or incorrect API key</li>
      <li><code>500 Internal Server Error</code>: missing configuration (e.g., API_KEY not set)</li>
    </ul>
  </section>

  <section>
    <h2>Deployment Notes (Vercel)</h2>
    <ul>
      <li><code>src/index.ts</code> is the Express entrypoint for Vercel.</li>
      <li><code>vercel.json</code> uses the Vercel v2 format (no custom routes).</li>
      <li><code>git push</code> to <code>main</code> deploys to Vercel automatically.</li>
      <li>Local dev reads <code>.env.dev</code>; local prod reads <code>.env.prod</code> when <code>DOBIE_ENV=prod</code> is set.</li>
      <li>Set <code>API_KEY</code>, <code>TARGET_URL</code>, and a database URL in Vercel environment variables.</li>
      <li>Run <code>npm run migrate</code> with the same env vars to apply schema changes.</li>
    </ul>
  </section>
</body>
</html>
